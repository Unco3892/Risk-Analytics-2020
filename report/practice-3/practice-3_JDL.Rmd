---
title: "report"
output: html_document
---

```{r, message=FALSE, warning=FALSE}
source(here::here("scripts/setup.R"))

library(reshape2)
library(copula)
```


```{r}
sales_10_adj <-
  read.csv(here::here("data/sales_10_adjusted.csv"))
```

Question for  Max :
- uniformised data don't work.
- Which model for var?
- VaR @ 95% for each then sum?

## a)


## b)

```{r}
nb_prod <- length(sales_10_adj)

chi <- matrix(NA, nb_prod, nb_prod)

colnames(chi) <- 1:10
rownames(chi) <- 1:10

for (i in 1:(nb_prod - 1)){
  for (j in (i + 1):nb_prod){
    chi[i,j] <- extRemes::taildep(sales_10_adj[,i], sales_10_adj[,j], 0.9)[[1]]
  }
}

longChi<-melt(chi)

longChi %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = factor(Var1), y = factor(Var2))) +
  geom_raster(aes(fill=value)) +
  scale_fill_gradient(low="grey90", high="red") +
  labs(x="product", y="product", title="chi")
```

```{r}
nb_prod <- length(sales_10_adj)

pvalue <- matrix(NA, nb_prod, nb_prod)

for (i in 1:(nb_prod - 1)) {
  for (j in (i + 1):nb_prod) {
    pvalue[i, j] <-
      extRemes::taildep.test(sales_10_adj[, i], 
                             sales_10_adj[, j], 
                             cthresh =
                               -0.1)$p.value[[1]]
  }
}

longPval<-melt(pvalue)

longPval %>%
  filter(!is.na(value)) %>%
  ggplot(aes(x = factor(Var1), y = factor(Var2))) +
  geom_raster(aes(fill=value)) +
  scale_fill_gradient(low="grey90", high="blue", breaks = c(0, 0.05, 1)) +
  labs(x="product", y="product", title="Pval")
```

Null hypothesis is tail dependence!

High tail dependence for extreme values :
```{r}
chiplot(cbind(sales_10_adj[,2], sales_10_adj[,3]), which = 1)
```

Low tail dependence for extreme values :
```{r}
chiplot(cbind(sales_10_adj[,2], sales_10_adj[,10]), which = 1)
```


## c)

The Gaussian copula is asymptotically independent in both upper and lower tails.
Since a significant amount of pairs are dependent in upper tail, the Gaussian copula seems not appropriate.

## d)
### .i
```{r}
thresholds <- numeric(10)

for (i in 1:10) {
  thresholds[i] <- quantile(sales_10_adj[,i], 0.9)
}


fit_pot <- list()

for (i in 1:10) {
  fit_pot[[i]] <- evd::fpot(sales_10_adj[,i], thresholds[i])
}


uniformised <- sapply(1:10, function (i) {
    dgpd(
      sales_10_adj[, i],
      loc = thresholds[i],
      scale = fit_pot[[i]]$estimate[1],
      shape = fit_pot[[i]]$estimate[2]
    )
})
```

Is there a problem?

```{r}
plot(uniformised[,1] , uniformised[,2])
```


### .ii  DOES NOT WORK, pb with uniformised matrix. NOT a problem of starting values.
```{r}
fit_normal <- fitCopula(normalCopula(dim = 10), uniformised, method = "ml")

summary(fit_normal)
```

```{r}
fit_gumbel <- fitCopula(gumbelCopula(dim = 10), uniformised, method = "ml")

summary(fit_gumbel)
```

```{r}
fit_clayton <- fitCopula(claytonCopula(dim = 10), uniformised, method = "ml")

summary(fit_clayton)

alpha <- coef(fit_clayton)[1]
```


```{r}
fit_t <- fitCopula(tCopula(dim = 10), uniformised)

summary(fit_t)

rho <- coef(fit_t)[1]
df <- coef(fit_t)[2]
```

### .iii

```{r}
param <- lapply(1:10, function (i) {
    list(
      loc = thresholds[i],
      scale = models[[i]]$estimate[1],
      shape = models[[i]]$estimate[2]
    )
})

copula_dist <-
  mvdc(
    copula = tCopula(rho, dim = 10, df = df),
    margins = rep(("gpd"), 10),
    paramMargins = param
  )

sim <- rMvdc(1913, copula_dist)
```

```{r}

```


